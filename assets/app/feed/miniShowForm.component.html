<div class="container">
    <form [formGroup]="questionnaire">
    <div formArrayName="questions">
        <div  id="miniFormQuestionBox" *ngFor="let question of data.questions; let i = index">
            <div class="row">
                <div *ngIf="(data.answered && data.showdata);then withanswer else formonly"></div>
                <ng-template #withanswer>
                    <div class="col-md-6">
                        <div class="mx-auto form-group" [formGroupName]="i" *ngIf="i == 0 || !data.contracted">
                            <label class="lead">{{question.number}}. {{question.body}}<span *ngIf="question.required">*</span></label>
                            <div *ngIf="question.pic" class="form-group question-pic">
                                <img [src]="question.pic"/>
                            </div>
                            <div  *ngIf="question.options">
                                <div *ngIf="question.kind == 'Radio'">
                                    <div *ngFor="let option of question.options" class="form-control">
                                        <input formControlName="answer" [value]="option.body" type="radio"/>
                                        <label>{{option.body}}</label>
                                    </div>
                                </div>
                                <div *ngIf="question.kind == 'Checkboxes'" formGroupName="answer">
                                    <div *ngFor="let option of question.options" class="form-control">
                                        <input [formControlName]="option.body" type="checkbox"/>
                                        <label>{{option.body}}</label>
                                    </div>
                                </div>
                                <select class="form-control" formControlName="answer" *ngIf="question.kind == 'Drop-down'">
                                    <option *ngFor="let option of question.options" [value]="option.body">{{option.body}}</option>
                                </select>
                                <div *ngIf="question.kind == 'Rank'" formGroupName="answer">
                                    <div [dragula]="'bag'" [dragulaModel]="questionnaire.get('questions').controls[i].get('answer').value">
                                        <div *ngFor="let option of questionnaire.get('questions').controls[i].get('answer').value; let j = index" class="form-control">
                                            <span class="rank">{{j + 1}}</span>
                                            <label>{{option}}</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="matrix" *ngIf="question.kind == 'Matrix'" formGroupName="answer">
                                    <table class="table-responsive">
                                        <thead>
                                        <tr>
                                            <td></td>
                                            <td class="label" *ngFor="let column of question.columns; let i = index">
                                                <div class="contents">
                                                    <label>{{column}}</label>
                                                </div>
                                            </td>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr class="matrix-row" *ngFor="let row of question.rows; let i = index">
                                            <td class="label">
                                                <div class="contents">
                                                    <label>{{row}}</label>
                                                </div>
                                            </td>
                                            <td class="field" *ngFor="let column of question.columns; let j = index">
                                                <div class="contents">
                                                    <input type="radio" [formControlName]="row" [value]="column"/>
                                                </div>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <input type="text" class="form-control" formControlName="answer" *ngIf="question.kind == 'Short answer'"/>
                            <textarea class="form-control" formControlName="answer" *ngIf="question.kind == 'Paragraph'"></textarea>
                            <div *ngIf="isInvalid(i)" class="invalid-feedback">
                                Option is required
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <app-doughnut-chart [dataLabels]="data.plotdata[i][0]" [dataValues]="data.plotdata[i][1]" *ngIf="(i == 0 || !data.contracted) && data.viewGraphsbool"></app-doughnut-chart>
                        <miniresults-table-component [data]="data.eventdatatotals[i]" *ngIf="(i == 0 || !data.contracted) && data.viewGraphsbool && data.eventplot"></miniresults-table-component>
                    </div>
                </ng-template>
                <ng-template #formonly>
                    <div class="col-md-12">
                        <div class="mx-auto form-group" [formGroupName]="i" *ngIf="i == 0 || !data.contracted">
                            <label  class="lead">{{question.number}}. {{question.body}}<span *ngIf="question.required">*</span></label>
                            <div *ngIf="question.pic" class="form-group question-pic">
                                <img [src]="question.pic"/>
                            </div>
                            <div  *ngIf="question.options">
                                <div *ngIf="question.kind == 'Radio'">
                                    <div *ngFor="let option of question.options" class="form-control">
                                        <input formControlName="answer" [value]="option.body" type="radio"/>
                                        <label>{{option.body}}</label>
                                    </div>
                                </div>
                                <div *ngIf="question.kind == 'Checkboxes'" formGroupName="answer">
                                    <div *ngFor="let option of question.options" class="form-control">
                                        <input [formControlName]="option.body" type="checkbox"/>
                                        <label>{{option.body}}</label>
                                    </div>
                                </div>
                                <select class="form-control" formControlName="answer" *ngIf="question.kind == 'Drop-down'">
                                    <option *ngFor="let option of question.options" [value]="option.body">{{option.body}}</option>
                                </select>
                                <div *ngIf="question.kind == 'Rank'" formGroupName="answer">
                                    <div [dragula]="'bag'" [dragulaModel]="questionnaire.get('questions').controls[i].get('answer').value">
                                        <div *ngFor="let option of questionnaire.get('questions').controls[i].get('answer').value; let j = index" class="form-control">
                                            <span class="rank">{{j + 1}}</span>
                                            <label>{{option}}</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="matrix" *ngIf="question.kind == 'Matrix'" formGroupName="answer">
                                    <table class="table-responsive">
                                        <thead>
                                            <tr>
                                                <td></td>
                                                <td class="label" *ngFor="let column of question.columns; let i = index">
                                                    <div class="contents">
                                                        <label>{{column}}</label>
                                                    </div>                                                        
                                                </td>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr class="matrix-row" *ngFor="let row of question.rows; let i = index">
                                                <td class="label">
                                                    <div class="contents">
                                                        <label>{{row}}</label>                                                
                                                    </div>
                                                </td>
                                                <td class="field" *ngFor="let column of question.columns; let j = index">
                                                    <div class="contents">
                                                        <input type="radio" [formControlName]="row" [value]="column"/>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <input type="text" class="form-control" formControlName="answer" *ngIf="question.kind == 'Short answer'"/>
                            <textarea class="form-control" formControlName="answer" *ngIf="question.kind == 'Paragraph'"></textarea>
                            <div *ngIf="isInvalid(i)" class="invalid-feedback">
                                Option is required
                            </div>
                        </div>
                    </div>
                </ng-template>

            </div>
        </div>

    </div>
    <div class="row" *ngIf="!data.contracted && !submitted">
        <div class="col-md-4"></div>
        <div class="col-md-4">
            <button 
                id="formSubmitButton" 
                *ngIf="showSubmit" 
                class="d-flex justify-content-center btn btn-outline-primary mouseChangeToHand"
                [disabled]="questionnaire.invalid && questionnaire.wasChecked"
                (click)="checkSubmit($event)">
                Submit Survey!
            </button>
            <div *ngIf="submissionfailed">Submission failed!</div>
        </div>
        <div class="col-md-4"></div>
    </div>
    <div class="row" *ngIf="submitted">
        <div class="col text-center submitted-message">
            <p class="alert alert-success">The survey has already been completed!</p>
        </div>
    </div>
    <div class="row" *ngIf="expired">
        <div class="col text-center submitted-message">
            <p class="alert alert-success">The survey has expired, no further answers are allowed!</p>
        </div>
    </div>
</form>
</div>